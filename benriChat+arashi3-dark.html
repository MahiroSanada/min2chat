<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>min2 Chat</title>
<meta name="color-scheme" content="light dark" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
:root{ --bg: #000000; --panel: #000000; --panel-2: #000000; --text: #ffffff; --muted: #aaaaaa; --accent: #ffffff; --accent-2: #ffffff; --danger: #ffffff; --success: #ffffff; --warning: #ffffff; --border: #444444; --bubble: #000000; --bubble-self: #222222; --shadow: none; --radius: 14px; --radius-sm: 10px; --radius-lg: 22px; --admin-bg: #ffffff; --admin-text: #000000; }
* { box-sizing: border-box; }
html, body { height:100%; margin:0; padding:0; }
body { font-family: "CustomFont", "Noto Sans JP", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Meiryo", sans-serif; background: var(--bg); color: var(--text); }
.app { display:flex; flex-direction:column; height:100dvh; max-width:900px; margin:0 auto; }
header.appbar { position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background: #000000; border-bottom:1px solid var(--border); }
.brand { display:flex; align-items:center; gap:10px; }
.logo { width:28px; height:28px; border-radius:10px; background: #ffffff; }
.title { font-weight:700; letter-spacing:0.2px; color: #ffffff; }
.status { display:flex; align-items:center; gap:8px; font-size:13px; color: var(--muted); }
.dot { width:10px; height:10px; border-radius:50%; background: #444; }
.dot.online { background: #fff; }
.dot.offline { background: #666; }
.toolbar { display:flex; gap:8px; }

/* ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š */
button.btn { appearance:none; border:1px solid #ffffff; color: #ffffff; background: transparent; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; transition: background 0.3s ease, color 0.3s ease; }
button.btn:hover { background: #ffffff; color: #000000; }
button.btn:active { transform: translateY(1px); }
.btn.accent { border-color:#ffffff; background: transparent; color: #ffffff; }
.btn.accent:hover { background: #ffffff; color: #000000; }
.btn.danger { border-color:#ffffff; background: transparent; color:#ffffff; }
.btn.danger:hover { background: #ffffff; color: #000000; }

.material-symbols-outlined { color: inherit !important; vertical-align: middle; }
main { flex:1; overflow:auto; padding:14px 12px 0 12px; }
.notice { text-align:center; color: var(--muted); font-size:13px; margin:8px 0 16px; }
.messages { display:flex; flex-direction:column; gap:10px; padding-bottom:16px; }
.msg { display:flex; gap:10px; max-width:92%; }
.msg.self { align-self:flex-end; flex-direction:row-reverse; }
.avatar { width:36px; height:36px; border-radius:10px; background:#000; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
.bubble { background: var(--bubble); border:1px solid var(--border); border-radius:14px; padding:10px 12px; min-width:120px; position: relative; }
.self .bubble { background: var(--bubble-self); border-color: #666; }
.meta { display:flex; align-items:center; gap:6px; color: var(--muted); font-size:12px; margin-bottom:6px; flex-wrap: wrap; }
.name { font-weight:700; color:#ffffff; display:inline-flex; align-items:center; gap:8px; }
.msg-seed { font-family: ui-monospace, monospace; font-size: 10px; background: #000; border: 1px solid var(--border); padding: 2px 5px; border-radius: 4px; color: #ffffff; }
.admin-badge { display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; background:#ffffff; color:#000000; font-weight:700; margin-left:6px; border:1px solid #ffffff; }
.text { white-space:pre-wrap; word-wrap:break-word; line-height:1.5; color: #ffffff; }
.text img { max-width: 100%; border-radius: 8px; margin-top: 4px; display: block; filter: grayscale(100%); }
.text-wrapper:not(.expanded)::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(transparent, #000); pointer-events: none; }
.self .text-wrapper:not(.expanded)::after { background: linear-gradient(transparent, #222); }
.expand-btn-sm, .expand-btn-main { background: transparent; border: none; color: #ffffff; cursor: pointer; }

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚‚åŒæ§˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.react, .react-static { display:inline-flex; align-items:center; gap:6px; font-size:13px; padding:6px 8px; border-radius:30px; border:1px solid var(--border); background: transparent; color:#ffffff; cursor:pointer; transition: background 0.3s ease, color 0.3s ease; }
.react:hover { border-color:#ffffff; background: #ffffff; color: #000000; }

footer.composer { position:sticky; bottom:0; z-index:10; background: #000; border-top:1px solid var(--border); padding:12px; }
.row { display:flex; gap:10px; align-items:flex-start; }
.input { flex:1; display:flex; padding:8px; gap:8px; border:1px solid #666; border-radius:var(--radius); background: #000000 !important; }
.u-box { display:flex; align-items:center; gap:8px; border-right:1px solid #666; padding-right:8px; min-width:120px; background: #000000; }
.u-tag { display:flex; align-items:center; gap:8px; border:1px solid #666; border-radius:10px; padding:6px 8px; color:#ffffff; background:#111; }
textarea { flex:1; resize:none; border:0; outline:0; background: #000000 !important; color: #ffffff !important; font:inherit; padding:4px 2px; min-height:44px; max-height:160px; }
textarea::placeholder { color: #666; }
.send { display:flex; gap:10px; align-items: center; }
.toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#ffffff; color:#000000; border:1px solid #ffffff; border-radius:12px; padding:10px 14px; font-size:14px; opacity:0; z-index: 100; font-weight: bold; }
.toast.show { opacity:1; }
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; padding:16px; z-index:20; }
.modal-backdrop.show { display:flex; }
.modal { width:min(520px,100%); background:#000; border:1px solid #666; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:12px; color: #ffffff; }
.modal h3 { margin:0; font-size:18px; color: #ffffff; border-bottom: 1px solid #444; padding-bottom: 8px; }
.field { display:flex; flex-direction:column; gap:8px; }
.field label { font-size:13px; color: #ffffff; font-weight: bold; }
.field input, .field textarea { width:100%; padding:10px; border:1px solid #666; border-radius:10px; background:#000000 !important; color: #ffffff !important; }
.time-options { display: flex; flex-direction: column; gap: 6px; background: #000; padding: 10px; border-radius: 10px; border: 1px solid #666; max-height: 300px; overflow-y: auto; color: #ffffff !important; }
.time-opt { display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; padding: 6px 0; color: #ffffff !important; }
.time-opt input[type="radio"] { accent-color: #ffffff; width: 18px; height: 18px; margin: 0; }
.switch { position: relative; display: inline-block; width: 44px; height: 22px; }
.slider { position: absolute; cursor: pointer; inset: 0; background-color: #444; transition: .3s; border-radius: 22px; border: 1px solid #666; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
input:checked + .slider { background-color: #ffffff; }
input:checked + .slider:before { transform: translateX(22px); background-color: #000000; }
.preset-list { display: flex; flex-direction: column; gap: 8px; background: #000; padding: 10px; border-radius: 10px; border: 1px solid #666; }
.preset-item { display: flex; align-items: center; justify-content: space-between; background: #111; padding: 8px; border-radius: 8px; border: 1px solid #444; color: #ffffff; }
@media (max-width:600px) { .u-box { display:none; } .msg { max-width:100%; } }
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">min2 Chat</div>
    </div>
    <div class="status">
      <div id="connDot" class="dot" title="æ¥ç¶šçŠ¶æ…‹"></div>
      <div id="connText">æ¥ç¶šä¸­...</div>
      <span aria-hidden="true">â€¢</span>
      <div id="userCount">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: -</div>
    </div>
    <div class="toolbar">
      <button id="openUser" class="btn" type="button">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
      <button id="openReactSettings" class="btn" type="button">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š</button>
      <button id="openPreset" class="btn" type="button">ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="openAdmin" class="btn danger" type="button" title="ç®¡ç†è€…ç”¨">ç®¡ç†</button>
    </div>
  </header>
  <main>
    <div id="notice" class="notice">ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ä¼šè©±ã§ãã¾ã™ã€‚Shift+Enterã§æ”¹è¡Œã€Enterã§é€ä¿¡ã€‚</div>
    <div id="messages" class="messages" aria-live="polite" aria-busy="true"></div>
  </main>
  <footer class="composer">
    <div class="row">
      <div class="input">
        <div class="u-box">
          <div class="u-tag"><span>ã‚ãªãŸ</span><strong id="usernameTag"></strong></div>
          <button id="editUser" class="btn u-edit" type="button" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç·¨é›†">ç·¨é›†</button>
        </div>
        <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›"></textarea>
        <input type="file" id="imageInput" accept="image/*" style="display:none;" />
        <button id="imgBtn" class="btn" type="button" title="ç”»åƒã‚’é€ã‚‹">ğŸ“·</button>
      </div>
      <div class="send">
        <input type="file" id="fontInput" accept=".ttf,.otf,.woff,.woff2" style="display:none;" />
        <button id="fontBtn" class="btn" type="button" title="ãƒ•ã‚©ãƒ³ãƒˆã‚’å¤‰æ›´">A</button>
        <button id="sendBtn" class="btn accent" type="button">é€ä¿¡</button>
      </div>
    </div>
  </footer>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div id="userModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="userTitle">
  <div class="modal" role="document">
    <h3 id="userTitle">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
    <div class="field"><label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input id="username" type="text" placeholder="ä¾‹: ãŸã‚ã†" /></div>
    <div class="field">
      <label for="seed">ã‚ãªãŸã®è­˜åˆ¥å­ <span class="kbd">seed</span></label>
      <div class="row-input"><input id="seed" type="text" placeholder="seedã‚’å…¥åŠ›..." /><button id="seedReload" class="btn" type="button">ğŸ”„</button></div>
    </div>
    <div class="field">
      <label>æ™‚åˆ»ã®è¨­å®š</label>
      <div id="mainTimeOptions" class="time-options"></div>
      <input id="customTimeText" type="text" placeholder="ã€Œã“ã“ã«ã¯æ™‚åˆ»ãŒã‚ã£ãŸã€ãªã©..." style="margin-top:4px; display:none;" />
    </div>
    <div class="actions"><button id="userCancel" class="btn" type="button">é–‰ã˜ã‚‹</button><button id="userSave" class="btn accent" type="button">ä¿å­˜</button></div>
  </div>
</div>

<div id="presetModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</h3>
    <div id="presetList" class="preset-list"></div>
    <hr style="border:0; border-top:1px solid var(--border); margin:5px 0;">
    <div class="field"><label>ç®¡ç†ç”¨ã®åå‰</label><input id="preTitle" type="text" placeholder="ä¾‹: æŒ¨æ‹¶ã‚»ãƒƒãƒˆ" /></div>
    <div class="field"><label>ä¸€æ™‚çš„ãªåå‰</label><input id="preName" type="text" placeholder="ç©ºæ¬„ãªã‚‰ç¾åœ¨ã®åå‰" /></div>
    <div class="field"><label>é€ä¿¡ã™ã‚‹æœ¬æ–‡</label><textarea id="preText" style="border:1px solid var(--border); border-radius:10px; background:#0f1330; padding:10px; color:var(--text); resize:none; min-height:60px;"></textarea></div>
    <div class="field">
      <label>ä¸€æ™‚çš„ãªæ™‚åˆ»å½¢å¼</label>
      <div id="presetTimeOptions" class="time-options"></div>
      <input id="preCustomTimeText" type="text" placeholder="ã€Œã“ã“ã«ã¯æ™‚åˆ»ãŒã‚ã£ãŸã€ãªã©..." style="margin-top:4px; display:none;" />
    </div>
    <div class="actions">
      <button id="presetCancel" class="btn" type="button">é–‰ã˜ã‚‹</button>
      <button id="presetAdd" class="btn accent" type="button">æ–°è¦è¿½åŠ </button>
    </div>
  </div>
</div>

<div id="reactModal" class="modal-backdrop" role="dialog" aria-modal="true"><div class="modal">
    <h3>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š</h3>
    <div class="field"><label for="customEmojis">çµµæ–‡å­—ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="customEmojis" type="text" /></div>
    <div class="field"><label for="clickPower">ã‚¯ãƒªãƒƒã‚¯å¢—åŠ æ•°</label><input id="clickPower" type="number" min="1" /></div>
    <div class="actions"><button id="reactCancel" class="btn" type="button">é–‰ã˜ã‚‹</button><button id="reactSave" class="btn accent" type="button">ä¿å­˜</button></div>
</div></div>

<div id="adminModal" class="modal-backdrop" role="dialog" aria-modal="true"><div class="modal">
    <h3>ç®¡ç†ãƒ‘ãƒãƒ«</h3>
    <div class="field"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input id="adminPass" type="password" /></div>
    <div class="field"><div class="admin-row"><label>è‡ªå‹•æœ€æ–°æŠ•ç¨¿BAN</label><label class="switch"><input type="checkbox" id="autoBanToggle"><span class="slider"></span></label></div></div>
    <div class="field"><div class="admin-row"><label>ã‚·ãƒ¼ãƒ‰æ›´æ–°ãƒ»é€£æŠ•</label><label class="switch"><input type="checkbox" id="autoSpamMode"><span class="slider"></span></label></div></div>
    <div class="field"><label>ãªã‚Šãã‚Šé€£æŠ•</label><div class="admin-row-input"><label class="switch"><input type="checkbox" id="mimicMode"><span class="slider"></span></label><input id="mimicText" type="text" /></div></div>
    <div class="field"><label>æœ¬æ–‡BAN</label><div class="admin-row-input"><label class="switch"><input type="checkbox" id="autoNgBanToggle"><span class="slider"></span></label><input id="ngWords" type="text" /></div></div>
    <div class="field"><label>åå‰BAN</label><div class="admin-row-input"><label class="switch"><input type="checkbox" id="autoNameBanToggle"><span class="slider"></span></label><input id="banNameWords" type="text" /></div></div>
    <div class="field"><div class="admin-row"><label>å‰Šé™¤ä¿è­·ãƒ¢ãƒ¼ãƒ‰</label><label class="switch"><input type="checkbox" id="keepLocalToggle"><span class="slider"></span></label></div></div>
    <div class="field"><div class="admin-row"><label>é«˜é€Ÿå…¨å‰Šé™¤</label><label class="switch"><input type="checkbox" id="autoClearToggle"><span class="slider"></span></label></div></div>
    <div class="field"><div class="admin-row"><label>é«˜é€Ÿã‚·ãƒ¼ãƒ‰å†ç”Ÿæˆ</label><label class="switch"><input type="checkbox" id="autoSeedToggle"><span class="slider"></span></label></div></div>
    <div class="field"><label>Seedæœ«å°¾å›ºå®š</label><div class="admin-row-input"><label class="switch"><input type="checkbox" id="fixedSuffixToggle"><span class="slider"></span></label><input id="fixedSuffixText" type="text" /></div></div>
    <div class="actions"><button id="adminClose" class="btn" type="button">é–‰ã˜ã‚‹</button><button id="adminAuthBtn" class="btn" type="button">ç®¡ç†è€…èªè¨¼</button><button id="clearBtn" class="btn danger" type="button">å…¨å‰Šé™¤</button></div>
</div></div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  'use strict';
  const SERVER_URL = 'https://one.linco.cl';
  const MASTER_PASS = 'min0001';
  let socket = null, messages = [], mySeed = null, myName = null, sending = false, timeMode = 'normal', customTimeValue = '', autoBanEnabled = false, lastOtherUser = "ä¸æ˜", autoSpamInterval = null, autoClearInterval = null, autoSeedInterval = null, keepLocalMode = false;

  const timeModesList = [
    {v:'normal', l:'æ™®é€š (YYYY/MM/DD HH:MM)'}, {v:'mod', l:'æ”¹é€  (HH:MM:SS)'}, {v:'sys', l:'ã‚·ã‚¹ãƒ†ãƒ  (ISO String)'},
    {v:'HH:MM:SS', l:'HH:MM:SS'}, {v:'H:MM:SS', l:'H:MM:SS'}, {v:'HH:MM', l:'HH:MM'}, {v:'MM:SS', l:'MM:SS'},
    {v:'SS.sss', l:'SS.sss'}, {v:'YYYY-MM-DD', l:'YYYY-MM-DD'}, {v:'DD/MM/YYYY', l:'DD/MM/YYYY'},
    {v:'MM/DD/YYYY', l:'MM/DD/YYYY'}, {v:'YYYY/MM/DD HH:MM:SS', l:'YYYY/MM/DD HH:MM:SS'},
    {v:'YYYY-MM-DDTHH:MM:SSZ', l:'YYYY-MM-DDTHH:MM:SSZ'}, {v:'Y:M:D', l:'Y:M:D'}, {v:'D-M-Y', l:'D-M-Y'},
    {v:'Yå¹´MæœˆDæ—¥', l:'Yå¹´MæœˆDæ—¥'}, {v:'DAYS:HOURS:MINUTES:SECONDS', l:'DAYS:HOURS:MINUTES:SECONDS'},
    {v:'HH:MM:SS.sss', l:'HH:MM:SS.sss'}, {v:'YY:DDD:HH:MM:SS', l:'YY:DDD:HH:MM:SS'},
    {v:'YYYY-MM-DD HH:MM:SS Â±HH:MM', l:'YYYY-MM-DD HH:MM:SS Â±HH:MM'},
    {v:'YYYY-MM-DD HH:MM:SSZ', l:'YYYY-MM-DD HH:MM:SSZ'}, {v:'Unixç§’', l:'Unixç§’'},
    {v:'UnixãƒŸãƒªç§’', l:'UnixãƒŸãƒªç§’'}, {v:'MM:SS:MS', l:'MM:SS:MS'}, {v:'HHh MMm SSs', l:'HHh MMm SSs'},
    {v:'ISO 8601æœŸé–“ä¾‹', l:'ISO 8601æœŸé–“ä¾‹'}, {v:'custom', l:'ä»»æ„'}
  ];

  const localMsgsKey = 'chat_messages_backup_v1', reactStorageKey = 'chat_custom_reacts_v1', adminStorageKey = 'chat_admin_seeds_v1', presetStorageKey = 'chat_presets_v1';
  
  const loadReactSettings = () => { try { return JSON.parse(localStorage.getItem(reactStorageKey)) || { emojis: ['ğŸ˜‚','ğŸ¤”','ğŸš€','ğŸ”¥','ğŸ™','âœ¨'], power: 1 }; } catch { return { emojis: ['ğŸ˜‚','ğŸ¤”','ğŸš€','ğŸ”¥','ğŸ™','âœ¨'], power: 1 }; } };
  const saveReactSettings = s => localStorage.setItem(reactStorageKey, JSON.stringify(s));
  let reactSettings = loadReactSettings();
  const loadAdminSeeds = () => { try { return new Set(JSON.parse(localStorage.getItem(adminStorageKey)||'[]')); } catch { return new Set(); } };
  const saveAdminSeeds = s => localStorage.setItem(adminStorageKey, JSON.stringify([...s]));
  let adminSeeds = loadAdminSeeds();

  const storage = {
    get name(){ return localStorage.getItem('chat_username')||''; }, set name(v){ localStorage.setItem('chat_username',v); },
    get seed(){ return localStorage.getItem('chat_seed')||''; }, set seed(v){ localStorage.setItem('chat_seed',v); },
    get timeMode(){ return localStorage.getItem('chat_time_mode')||'normal'; }, set timeMode(v){ localStorage.setItem('chat_time_mode',v); },
    get customTime(){ return localStorage.getItem('chat_custom_time')||''; }, set customTime(v){ localStorage.setItem('chat_custom_time',v); },
    get mimicText(){ return localStorage.getItem('chat_mimic_text')||''; }, set mimicText(v){ localStorage.setItem('chat_mimic_text',v); },
    get ngWords(){ return localStorage.getItem('chat_ng_words')||''; }, set ngWords(v){ localStorage.setItem('chat_ng_words',v); },
    get banNameWords(){ return localStorage.getItem('chat_ban_name_words')||''; }, set banNameWords(v){ localStorage.setItem('chat_ban_name_words',v); },
    get adminPass(){ return localStorage.getItem('chat_admin_pass')||''; }, set adminPass(v){ localStorage.setItem('chat_admin_pass',v); },
    get currentInput(){ return localStorage.getItem('chat_current_input')||''; }, set currentInput(v){ localStorage.setItem('chat_current_input',v); },
    get presets(){ try{ return JSON.parse(localStorage.getItem(presetStorageKey))||[]; }catch{return [];} }, set presets(v){ localStorage.setItem(presetStorageKey, JSON.stringify(v)); },
    get fixedSuffixText(){ return localStorage.getItem('chat_fixed_suffix_text')||''; }, set fixedSuffixText(v){ localStorage.setItem('chat_fixed_suffix_text',v); }
  };

  const el = {
    connDot: document.getElementById('connDot'), connText: document.getElementById('connText'), userCount: document.getElementById('userCount'), messages: document.getElementById('messages'), notice: document.getElementById('notice'), usernameTag: document.getElementById('usernameTag'), input: document.getElementById('messageInput'), send: document.getElementById('sendBtn'), toast: document.getElementById('toast'), userModal: document.getElementById('userModal'), userOpen: document.getElementById('openUser'), userEdit: document.getElementById('editUser'), userSave: document.getElementById('userSave'), userCancel: document.getElementById('userCancel'), username: document.getElementById('username'), seed: document.getElementById('seed'), seedReload: document.getElementById('seedReload'), customTimeText: document.getElementById('customTimeText'), adminModal: document.getElementById('adminModal'), adminOpen: document.getElementById('openAdmin'), adminClose: document.getElementById('adminClose'), adminPass: document.getElementById('adminPass'), clearBtn: document.getElementById('clearBtn'), adminAuthBtn: document.getElementById('adminAuthBtn'), reactModal: document.getElementById('reactModal'), reactOpen: document.getElementById('openReactSettings'), reactSave: document.getElementById('reactSave'), reactCancel: document.getElementById('reactCancel'), customEmojis: document.getElementById('customEmojis'), clickPower: document.getElementById('clickPower'), autoBanToggle: document.getElementById('autoBanToggle'), autoSpamMode: document.getElementById('autoSpamMode'), mimicMode: document.getElementById('mimicMode'), mimicText: document.getElementById('mimicText'), autoNgBanToggle: document.getElementById('autoNgBanToggle'), ngWords: document.getElementById('ngWords'), autoClearToggle: document.getElementById('autoClearToggle'), autoSeedToggle: document.getElementById('autoSeedToggle'), autoNameBanToggle: document.getElementById('autoNameBanToggle'), banNameWords: document.getElementById('banNameWords'), imageInput: document.getElementById('imageInput'), imgBtn: document.getElementById('imgBtn'), keepLocalToggle: document.getElementById('keepLocalToggle'),
    presetModal: document.getElementById('presetModal'), openPreset: document.getElementById('openPreset'), presetCancel: document.getElementById('presetCancel'), presetList: document.getElementById('presetList'), preTitle: document.getElementById('preTitle'), preName: document.getElementById('preName'), preText: document.getElementById('preText'), presetAdd: document.getElementById('presetAdd'), mainTimeOptions: document.getElementById('mainTimeOptions'), presetTimeOptions: document.getElementById('presetTimeOptions'), preCustomTimeText: document.getElementById('preCustomTimeText'),
    fontInput: document.getElementById('fontInput'), fontBtn: document.getElementById('fontBtn'),
    fixedSuffixToggle: document.getElementById('fixedSuffixToggle'), fixedSuffixText: document.getElementById('fixedSuffixText')
  };

  const showToast = (m, ms=1800) => { el.toast.textContent = m; el.toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>el.toast.classList.remove('show'), ms); };
  
  const formatTime = (modeOverride, customOverride) => {
    const d = new Date();
    const target = modeOverride || timeMode;
    const Y = d.getFullYear(), M = d.getMonth()+1, D = d.getDate(), H = d.getHours(), Min = d.getMinutes(), S = d.getSeconds(), MS = d.getMilliseconds();
    const pad = n => String(n).padStart(2,'0');
    const pad3 = n => String(n).padStart(3,'0');
    switch(target) {
      case 'HH:MM:SS': case 'mod': return `${pad(H)}:${pad(Min)}:${pad(S)}`;
      case 'H:MM:SS': return `${H}:${pad(Min)}:${pad(S)}`;
      case 'HH:MM': return `${pad(H)}:${pad(Min)}`;
      case 'MM:SS': return `${pad(Min)}:${pad(S)}`;
      case 'SS.sss': return `${pad(S)}.${pad3(MS)}`;
      case 'YYYY-MM-DD': return `${Y}-${pad(M)}-${pad(D)}`;
      case 'DD/MM/YYYY': return `${pad(D)}/${pad(M)}/${Y}`;
      case 'MM/DD/YYYY': return `${pad(M)}/${pad(D)}/${Y}`;
      case 'YYYY/MM/DD HH:MM:SS': return `${Y}/${pad(M)}/${pad(D)} ${pad(H)}:${pad(Min)}:${pad(S)}`;
      case 'YYYY-MM-DDTHH:MM:SSZ': return d.toISOString().split('.')[0] + 'Z';
      case 'Y:M:D': return `${Y}:${M}:${D}`;
      case 'D-M-Y': return `${D}-${M}-${Y}`;
      case 'Yå¹´MæœˆDæ—¥': return `${Y}å¹´${M}æœˆ${D}æ—¥`;
      case 'DAYS:HOURS:MINUTES:SECONDS': 
        const start = new Date(Y, 0, 0); const diff = d - start;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24)); return `${days}:${pad(H)}:${pad(Min)}:${pad(S)}`;
      case 'HH:MM:SS.sss': return `${pad(H)}:${pad(Min)}:${pad(S)}.${pad3(MS)}`;
      case 'YY:DDD:HH:MM:SS':
        const startYY = new Date(Y, 0, 0); const dayOfYear = Math.floor((d - startYY) / (1000 * 60 * 60 * 24));
        return `${String(Y).slice(-2)}:${pad3(dayOfYear)}:${pad(H)}:${pad(Min)}:${pad(S)}`;
      case 'YYYY-MM-DD HH:MM:SS Â±HH:MM':
        const offset = -d.getTimezoneOffset(), sign = offset>=0?'+':'-', offH = pad(Math.floor(Math.abs(offset)/60)), offM = pad(Math.abs(offset)%60);
        return `${Y}-${pad(M)}-${pad(D)} ${pad(H)}:${pad(Min)}:${pad(S)} ${sign}${offH}:${offM}`;
      case 'YYYY-MM-DD HH:MM:SSZ': return `${Y}-${pad(M)}-${pad(D)} ${pad(H)}:${pad(Min)}:${pad(S)}Z`;
      case 'Unixç§’': return Math.floor(d.getTime()/1000);
      case 'UnixãƒŸãƒªç§’': return d.getTime();
      case 'MM:SS:MS': return `${pad(Min)}:${pad(S)}:${pad3(MS)}`;
      case 'HHh MMm SSs': return `${H}h ${Min}m ${S}s`;
      case 'ISO 8601æœŸé–“ä¾‹': return `P1Y2M3DT${H}H${Min}M${S}S`;
      case 'custom': return customOverride || customTimeValue || 'æ™‚åˆ»ãªã—';
      case 'sys': return d.toISOString();
      default: return `${Y}/${pad(M)}/${pad(D)} ${pad(H)}:${pad(Min)}`;
    }
  };

  const makeSeed = () => { if(crypto?.getRandomValues){ const a=new Uint8Array(16); crypto.getRandomValues(a); return [...a].map(x=>x.toString(16).padStart(2,'0')).join(''); } return Math.random().toString(36).slice(2)+Date.now().toString(36); };
  const getProcessedSeed = (rawSeed) => { if (el.fixedSuffixToggle.checked) { const sfx = el.fixedSuffixText.value; if (!rawSeed.endsWith(sfx)) return rawSeed + sfx; } return rawSeed; };
  const initials = n => (n||'?').trim().slice(0,2).toUpperCase();
  const isAtBottom = () => { const m=document.querySelector('main'); return m.scrollHeight-m.scrollTop-m.clientHeight < 80; };
  const scrollToBottom = s => { const m=document.querySelector('main'); m.scrollTo({ top:m.scrollHeight, behavior: s?'smooth':'auto' }); };
  const sanitizeText = t => String(t||'').replace(/\u0000/g, '');
  const isDuplicate = m => messages.some(x => x.seed===m.seed && x.time===m.time && x.message===m.message && x.username===m.username);
  
  const ADMIN_SUFFIX = '1123';
  function isSeedAdmin(s){ return s && (adminSeeds.has(s) || String(s).endsWith(ADMIN_SUFFIX)); }
  function renderAll(){ el.messages.innerHTML=''; messages.forEach((m,i)=>el.messages.appendChild(renderMessage(m,i))); el.messages.parentElement.setAttribute('aria-busy','false'); scrollToBottom(false); }
  async function callBanApi(s){ if(!s)return; try{ const r=await fetch(`${SERVER_URL}/api/ban/${s}/${myName}`); return r.ok; }catch{return false;} }
  
  function createExpandable(text, threshold, typeLabel) {
    const container = document.createElement('span');
    if (text.length >= threshold) {
      const wrapper = document.createElement('span'); wrapper.className = 'meta-wrapper'; wrapper.textContent = text;
      const btn = document.createElement('button'); btn.className = 'expand-btn-sm'; btn.innerHTML = '<span class="material-symbols-outlined">zoom_out_map</span>';
      btn.onclick = (e) => {
        e.stopPropagation();
        if (!wrapper.classList.contains('expanded')) {
          if (!confirm(`${typeLabel}ã‚’å±•é–‹ã—ã¾ã™ã‹ï¼Ÿ æ–‡å­—æ•° : ${text.length}`)) return;
        }
        wrapper.classList.toggle('expanded');
        btn.innerHTML = wrapper.classList.contains('expanded') ? '<span class="material-symbols-outlined">zoom_in_map</span>' : '<span class="material-symbols-outlined">zoom_out_map</span>';
      };
      container.append(wrapper, btn);
    } else {
      container.textContent = text;
    }
    return container;
  }

  function renderMessage(msg,idx){
    const isSelf = msg.seed===mySeed, isAdmin = isSeedAdmin(msg.seed), wrap = document.createElement('div');
    wrap.className = 'msg'+(isSelf?' self':''); wrap.dataset.index = idx;
    const av = document.createElement('div'); av.className='avatar'; av.textContent=initials(msg.username);
    const bub = document.createElement('div'); bub.className='bubble';
    const meta = document.createElement('div'); meta.className='meta';
    
    const nameSpan = document.createElement('span'); nameSpan.className='name';
    nameSpan.appendChild(createExpandable(sanitizeText(msg.username||'unknown'), 24, 'åå‰'));
    if(isAdmin){ const b=document.createElement('span'); b.className='admin-badge'; b.textContent='ç®¡ç†è€…'; nameSpan.appendChild(b); }
    
    const sd = document.createElement('span'); sd.className='msg-seed';
    sd.appendChild(createExpandable(msg.seed||'no-seed', 50, 'è­˜åˆ¥å­'));
    sd.onclick=(e)=>{ if(e.target.closest('.expand-btn-sm')) return; myName=msg.username; mySeed=msg.seed; storage.name=myName; storage.seed=mySeed; el.usernameTag.textContent=myName.slice(0,10); el.seed.value=mySeed; showToast('ãªã‚Šãã‚Šå®Œäº†'); renderAll(); };
    
    const tm = document.createElement('span');
    tm.appendChild(createExpandable(sanitizeText(msg.time||''), 25, 'æ™‚åˆ»'));
    
    meta.append(nameSpan, sd, tm);
    const txt = document.createElement('div'); txt.className='text';
    const ctxt = sanitizeText(msg.message||'');
    if(ctxt.startsWith('data:image/')){ const i=document.createElement('img'); i.src=ctxt; txt.appendChild(i); }else{ 
      if(ctxt.length >= 300) {
        const tw = document.createElement('div'); tw.className = 'text-wrapper'; tw.textContent = ctxt;
        const btn = document.createElement('button'); btn.className = 'expand-btn-main'; btn.innerHTML = '<span class="material-symbols-outlined">zoom_out_map</span>';
        btn.onclick = () => {
          if (!tw.classList.contains('expanded')) {
            if (!confirm(`ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±•é–‹ã—ã¾ã™ã‹ï¼Ÿ æ–‡å­—æ•° : ${ctxt.length}`)) return;
          }
          tw.classList.toggle('expanded');
          btn.innerHTML = tw.classList.contains('expanded') ? '<span class="material-symbols-outlined">zoom_in_map</span>' : '<span class="material-symbols-outlined">zoom_out_map</span>';
        };
        txt.appendChild(tw); bub.appendChild(btn);
      } else {
        txt.textContent=ctxt; 
      }
    }
    const reacts = document.createElement('div'); reacts.className='reactions';
    bub.insertBefore(meta, bub.firstChild); bub.appendChild(txt); bub.appendChild(reacts); wrap.append(av, bub);
    drawReactionButtons(idx, reacts, msg.reactions||{});
    if(!isSelf){ const b=document.createElement('button'); b.className='react'; b.style.color='var(--danger)'; b.textContent='BAN'; b.onclick=async()=>{ if(await callBanApi(msg.seed)) showToast('BANç”³è«‹'); }; reacts.appendChild(b); }
    return wrap;
  }

  function drawReactionButtons(id, cont, cur){
    cont.innerHTML='';
    Object.keys(cur).sort((a,b)=>(cur[b]||0)-(cur[a]||0)).forEach(k=>{ if(cur[k]>0){ const s=document.createElement('span'); s.className='react-static'; s.textContent=`${k} ${cur[k]}`; cont.appendChild(s); } });
    ['ğŸ‘','ğŸ˜¡'].forEach(r=>cont.appendChild(createReactBtn(id,r)));
    const sBtn=document.createElement('button'); sBtn.className='react'; sBtn.textContent='âš™'; sBtn.onclick=()=>{ sBtn.remove(); reactSettings.emojis.forEach(e=>cont.appendChild(createReactBtn(id,e))); };
    cont.appendChild(sBtn);
  }

  function createReactBtn(id, c){
    const b=document.createElement('button'); b.className='react'; b.textContent=c;
    b.onclick=()=>{ b.disabled=true; setTimeout(()=>b.disabled=false,1000); const p=Math.max(1,parseInt(reactSettings.power)||1); for(let i=0;i<p;i++) socket.emit('updateReaction',{messageId:id, reaction:c}); };
    return b;
  }

  async function fetchMessages(){ try{ el.messages.parentElement.setAttribute('aria-busy','true'); const r=await fetch(`${SERVER_URL}/api/messages`,{cache:'no-store'}); const d=await r.json(); messages=d; for(let i=messages.length-1;i>=0;i--){ if(messages[i].seed!==mySeed){lastOtherUser=messages[i].username;break;}} renderAll(); }catch{ showToast('å–å¾—å¤±æ•—'); } }
  async function fetchUserCount(){ try{ const r=await fetch(`${SERVER_URL}/user`); const j=await r.json(); el.userCount.textContent=`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ${j.userCount||'-'}`; }catch{ el.userCount.textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: -'; } }

  async function sendMessage(ov=null){
    let t = ov?ov.message:sanitizeText(el.input.value).trim(); if(!t && !ov)return;
    t = t.replace(/{%user%}/g, lastOtherUser);
    const n = ov?ov.username:myName, s = ov?ov.seed:mySeed, tm = ov?ov.time:formatTime();
    if(!n && !ov){ showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š'); openUserModal(); return; }
    const p = { username:n, message:t, time:tm, seed:s };
    if(!ov){ sending=true; el.send.disabled=true; }
    try{ const r=await fetch(`${SERVER_URL}/api/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}); if(!r.ok)throw 0; if(!ov && !el.autoSpamMode.checked){el.input.value=''; storage.currentInput=''; autoResize(el.input);} }catch{ if(!ov)showToast('é€ä¿¡å¤±æ•—'); }finally{ if(!ov){sending=false; el.send.disabled=false; el.input.focus();} }
  }

  const generateTimeUI = (container, groupName) => {
    container.innerHTML = '';
    timeModesList.forEach(m => {
      const label = document.createElement('label'); label.className = 'time-opt';
      label.innerHTML = `<input type="radio" name="${groupName}" value="${m.v}"> ${m.l}`;
      container.appendChild(label);
    });
  };

  const renderPresets = () => {
    const ps = storage.presets;
    el.presetList.innerHTML = ps.length ? '' : '<div style="font-size:12px;color:var(--muted);text-align:center;">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    ps.forEach((p, i) => {
      const item = document.createElement('div'); item.className = 'preset-item';
      item.innerHTML = `<span>${p.title}</span><div class="preset-item-btns">
        <button class="btn accent" onclick="window._sendPreset(${i})">é€ä¿¡</button>
        <button class="btn danger" onclick="window._delPreset(${i})">å‰Šé™¤</button>
      </div>`;
      el.presetList.appendChild(item);
    });
  };

  window._sendPreset = async (i) => {
    const p = storage.presets[i];
    await sendMessage({ username: p.name || myName, seed: mySeed, message: p.text, time: formatTime(p.timeMode, p.customValue) });
    showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆé€ä¿¡å®Œäº†');
  };

  window._delPreset = (i) => {
    const ps = storage.presets; ps.splice(i, 1); storage.presets = ps; renderPresets();
  };

  el.presetAdd.onclick = () => {
    const title = el.preTitle.value.trim() || 'ç„¡é¡Œ', text = el.preText.value.trim();
    if(!text){ showToast('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const ps = storage.presets;
    ps.push({ title, name: el.preName.value.trim(), text, timeMode: el.presetTimeOptions.querySelector('input:checked')?.value || 'normal', customValue: el.preCustomTimeText.value });
    storage.presets = ps; el.preTitle.value = el.preText.value = el.preName.value = el.preCustomTimeText.value = '';
    renderPresets(); showToast('è¿½åŠ ã—ã¾ã—ãŸ');
  };

  async function clearAllMessages(p){ try{ const r=await fetch(`${SERVER_URL}/api/pass`,{method:'POST',headers:{'Content-Type':'application/json','x-requested-with':'fetch'},body:JSON.stringify({password:p||MASTER_PASS})}); if(!r.ok)throw 0; if(!autoClearInterval)showToast('å±¥æ­´å‰Šé™¤'); }catch{ if(!autoClearInterval)showToast('å‰Šé™¤å¤±æ•—'); } }
  async function verifyAdminPasswordOnServer(p){ try{ const r=await fetch(`${SERVER_URL}/api/pass`,{method:'POST',headers:{'Content-Type':'application/json','x-requested-with':'fetch'},body:JSON.stringify({password:p||MASTER_PASS})}); return {ok:r.ok}; }catch{return {ok:false};} }
  
  function setupSocket(){
    socket = io(SERVER_URL,{transports:['polling'],reconnection:true});
    socket.on('connect',()=>{ el.connDot.className='dot online'; el.connText.textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'; fetchUserCount(); });
    socket.on('disconnect',()=>{ el.connDot.className='dot offline'; el.connText.textContent='åˆ‡æ–­'; setTimeout(()=>location.reload(),100); });
    socket.on('newMessage', m=>{
      if(isDuplicate(m))return; const bot=isAtBottom(); messages.push(m); if(keepLocalMode)localStorage.setItem(localMsgsKey,JSON.stringify(messages));
      if(m.seed!==mySeed) lastOtherUser=m.username; el.messages.appendChild(renderMessage(m,messages.length-1)); if(bot)scrollToBottom(true);
      if(m.seed!==mySeed){
        if(el.autoNgBanToggle.checked && el.ngWords.value.split(/[ ,ã€]+/).some(w=>w && m.message.includes(w))) callBanApi(m.seed);
        if(el.autoNameBanToggle.checked && el.banNameWords.value.split(/[ ,ã€]+/).some(w=>w && (m.username||'').includes(w))) callBanApi(m.seed);
        if(autoBanEnabled) callBanApi(m.seed);
        if(el.mimicMode.checked){
          const os=storage.seed, on=storage.name; let mt=(el.mimicText.value.trim()||m.message).replace(/{%user%}/g, lastOtherUser);
          mySeed=m.seed; myName=m.username; (async()=>{ for(let i=0;i<10;i++){ await sendMessage({username:myName, seed:mySeed, message:mt}); await new Promise(r=>setTimeout(r,100)); } mySeed=storage.seed=os; myName=storage.name=on; el.usernameTag.textContent=myName.slice(0,10); el.seed.value=mySeed; renderAll(); })();
        }
      }
    });
    socket.on('updateReaction',({messageId,reactions})=>{ if(messages[messageId]){ messages[messageId].reactions=reactions; updateReactions(messageId,reactions); } });
    socket.on('clearMessages', ()=>{ if(keepLocalMode){showToast('å‰Šé™¤ä¿è­·ä½œå‹•'); return;} messages=[]; el.messages.innerHTML=''; if(!autoClearInterval)showToast('å±¥æ­´å‰Šé™¤ã•ã‚Œã¾ã—ãŸ'); });
  }

  function updateReactions(id,rs){ const w=el.messages.querySelector(`.msg[data-index="${id}"]`); if(w){ const b=w.querySelector('.reactions'); if(b) drawReactionButtons(id,b,rs); } }
  function autoResize(t){ t.style.height='auto'; t.style.height=Math.min(160,Math.max(44,t.scrollHeight))+'px'; }
  function openUserModal(){ 
    el.username.value=myName||''; el.seed.value=mySeed||''; 
    const rb = el.mainTimeOptions.querySelector(`input[value="${timeMode}"]`); if(rb) rb.checked = true;
    el.customTimeText.value=customTimeValue; el.customTimeText.style.display=(timeMode==='custom'?'block':'none'); 
    el.userModal.classList.add('show'); 
  }

  el.input.addEventListener('input',()=>{ autoResize(el.input); storage.currentInput=el.input.value; });
  el.username.addEventListener('input',()=>storage.name=el.username.value); el.seed.addEventListener('input',()=>storage.seed=el.seed.value); el.customTimeText.addEventListener('input',()=>storage.customTime=el.customTimeText.value); el.adminPass.addEventListener('input',()=>storage.adminPass=el.adminPass.value);
  el.send.addEventListener('click',()=>sendMessage()); el.input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
  el.imgBtn.addEventListener('click',()=>el.imageInput.click()); el.imageInput.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f || f.size>2097152)return; const r=new FileReader(); r.onload=ev=>{sendMessage({username:myName,seed:mySeed,message:ev.target.result}); el.imageInput.value='';}; r.readAsDataURL(f); });
  el.userOpen.addEventListener('click',openUserModal); el.userEdit.addEventListener('click',openUserModal); el.userCancel.addEventListener('click',()=>el.userModal.classList.remove('show'));
  el.seedReload.addEventListener('click',()=>{ const ns=makeSeed(); mySeed=getProcessedSeed(ns); storage.seed=mySeed; el.seed.value=mySeed; showToast('Seedæ›´æ–°'); renderAll(); });
  el.userSave.addEventListener('click',()=>{ myName=el.username.value.trim(); mySeed=el.seed.value.trim(); timeMode=el.mainTimeOptions.querySelector('input:checked')?.value || 'normal'; customTimeValue=el.customTimeText.value; storage.name=myName; storage.seed=mySeed; storage.timeMode=timeMode; storage.customTime=customTimeValue; el.usernameTag.textContent=myName.slice(0,10); el.userModal.classList.remove('show'); renderAll(); });
  el.reactOpen.addEventListener('click',()=>{ el.customEmojis.value=reactSettings.emojis.join(','); el.clickPower.value=reactSettings.power; el.reactModal.classList.add('show'); });
  el.reactSave.addEventListener('click',()=>{ reactSettings={emojis:el.customEmojis.value.split(/[ ,ã€]+/).filter(x=>x), power:parseInt(el.clickPower.value)||1}; saveReactSettings(reactSettings); el.reactModal.classList.remove('show'); renderAll(); });
  el.adminOpen.addEventListener('click',()=>el.adminModal.classList.add('show')); el.adminClose.addEventListener('click',()=>el.adminModal.classList.remove('show'));
  el.clearBtn.addEventListener('click',()=>clearAllMessages(el.adminPass.value));
  el.adminAuthBtn.addEventListener('click',async()=>{ const r=await verifyAdminPasswordOnServer(el.adminPass.value); if(r.ok){ mySeed=mySeed.endsWith(ADMIN_SUFFIX)?mySeed:mySeed+ADMIN_SUFFIX; el.seed.value=mySeed; adminSeeds.add(mySeed); saveAdminSeeds(adminSeeds); showToast('èªè¨¼æˆåŠŸ'); renderAll(); }else showToast('å¤±æ•—'); });
  el.autoBanToggle.addEventListener('change',e=>{ autoBanEnabled=e.target.checked; showToast('è‡ªå‹•BAN:'+(e.target.checked?'ON':'OFF')); });
  el.autoSpamMode.addEventListener('change',e=>{ if(e.target.checked) autoSpamInterval=setInterval(()=>{const ns=makeSeed(); mySeed=getProcessedSeed(ns); sendMessage();},150); else clearInterval(autoSpamInterval); });
  el.autoClearToggle.addEventListener('change',e=>{ if(e.target.checked) autoClearInterval=setInterval(()=>clearAllMessages(el.adminPass.value),150); else clearInterval(autoClearInterval); });
  el.autoSeedToggle.addEventListener('change',e=>{ if(e.target.checked) autoSeedInterval=setInterval(()=>{const ns=makeSeed(); mySeed=getProcessedSeed(ns); el.seed.value=storage.seed=mySeed;},50); else clearInterval(autoSeedInterval); });
  el.keepLocalToggle.addEventListener('change',e=>{ keepLocalMode=e.target.checked; if(keepLocalMode)localStorage.setItem(localMsgsKey,JSON.stringify(messages)); else localStorage.removeItem(localMsgsKey); });
  el.fixedSuffixToggle.addEventListener('change', e => { if (e.target.checked) { mySeed = getProcessedSeed(mySeed); el.seed.value = storage.seed = mySeed; renderAll(); } showToast('æœ«å°¾å›ºå®š:'+(e.target.checked?'ON':'OFF')); });
  el.fixedSuffixText.addEventListener('input', () => storage.fixedSuffixText = el.fixedSuffixText.value);

  el.openPreset.onclick = () => { renderPresets(); el.presetModal.classList.add('show'); };
  el.presetCancel.onclick = () => el.presetModal.classList.remove('show');

  el.fontBtn.onclick = () => el.fontInput.click();
  el.fontInput.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const fontFace = new FontFace('CustomFont', ev.target.result);
      fontFace.load().then(loaded => {
        document.fonts.add(loaded);
        document.body.style.fontFamily = '"CustomFont", "Noto Sans JP", sans-serif';
        showToast('ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ');
      }).catch(() => showToast('ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'));
    };
    reader.readAsArrayBuffer(file);
  };

  [el.userModal, el.adminModal, el.reactModal, el.presetModal].forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');}));

  (async()=>{ 
    localStorage.removeItem(localMsgsKey); 
    generateTimeUI(el.mainTimeOptions, 'timeMode'); generateTimeUI(el.presetTimeOptions, 'preTimeMode');
    el.mainTimeOptions.addEventListener('change', e => el.customTimeText.style.display=(e.target.value==='custom'?'block':'none'));
    el.presetTimeOptions.addEventListener('change', e => el.preCustomTimeText.style.display=(e.target.value==='custom'?'block':'none'));

    myName=storage.name; mySeed=storage.seed||makeSeed(); timeMode=storage.timeMode; customTimeValue=storage.customTime; el.input.value=storage.currentInput; el.mimicText.value=storage.mimicText; el.ngWords.value=storage.ngWords; el.banNameWords.value=storage.banNameWords; el.adminPass.value=storage.adminPass||MASTER_PASS; el.fixedSuffixText.value=storage.fixedSuffixText; storage.seed=mySeed; el.usernameTag.textContent=myName?myName.slice(0,10):'æœªè¨­å®š'; el.seed.value=mySeed; autoResize(el.input); await fetchMessages(); setupSocket(); setInterval(fetchUserCount,30000); el.input.focus(); 
  })();
})();
</script>
</body>
</html>